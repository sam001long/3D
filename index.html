<!doctype html><html lang="zh-Hant"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>3D 運鏡模擬器（GLB 上傳）</title>
<script src="https://cdn.tailwindcss.com"></script>
</head><body class="bg-slate-950"><div id="root"></div>
<script type="module">
  import React,{Suspense,useEffect,useRef,useState} from 'https://esm.sh/react@18'
  import {createRoot} from 'https://esm.sh/react-dom@18/client'
  import * as THREE from 'https://esm.sh/three@0.160.0'
  import {Canvas,useFrame,useThree} from 'https://esm.sh/@react-three/fiber@8?external=react,react-dom,three'
  import {OrbitControls,PerspectiveCamera,useHelper,useGLTF} from 'https://esm.sh/@react-three/drei@9?external=react,react-dom,three,@react-three/fiber'
  const deg2rad=d=>d*Math.PI/180,DS={CLOSE:1.4,MEDIUM:2.5,WIDE:4.5},AM={BIRD:60,HIGH:30,LEVEL:0,LOW:-20};
  function cp(t,{style,dist,elevDeg,speed,focus}){const e=deg2rad(elevDeg),r=dist,y=r*Math.sin(e),rh=Math.max(.001,r*Math.cos(e)),a=Math.min(r*.35,focus.radius*1.2);let x=rh,z=0,phi=0,ty=focus.center.y+focus.radius*.1;switch(style){case"ORBIT":phi=t*speed;x=rh*Math.cos(phi);z=rh*Math.sin(phi);break;case"DOLLY":{const rr=r+a*Math.sin(t*speed),rrh=Math.max(.001,rr*Math.cos(e));x=rrh;z=0;break}case"TRUCK":{const dx=a*.6*Math.sin(t*speed);x=rh+dx;z=0;break}case"CRANE":{const dy=a*.6*Math.sin(t*speed);x=rh;z=0;return{position:[focus.center.x+x,ty+y+dy,focus.center.z+z],target:[focus.center.x,ty,focus.center.z]}}default:x=rh}return{position:[focus.center.x+x,ty+y,focus.center.z+z],target:[focus.center.x,ty,focus.center.z]}}
  function G(){return React.createElement('group',null,
    React.createElement('mesh',{receiveShadow:true,rotation:[-Math.PI/2,0,0],position:[0,-.001,0]},
      React.createElement('planeGeometry',{args:[40,40]}),
      React.createElement('meshStandardMaterial',{color:'#0b1220'})),
    React.createElement('gridHelper',{args:[40,40,'#334155','#1f2937'],position:[0,.001,0]}),
    React.createElement('axesHelper',{args:[1.2]}))}
  function D(){return React.createElement('group',null,
    React.createElement('mesh',{castShadow:true,position:[0,.8,0]},
      React.createElement('icosahedronGeometry',{args:[.6,1]}),
      React.createElement('meshStandardMaterial',{metalness:.1,roughness:.4,color:'#a3bffa'})),
    React.createElement('mesh',{castShadow:true,position:[0,.25,0]},
      React.createElement('cylinderGeometry',{args:[.35,.5,.5,24]}),
      React.createElement('meshStandardMaterial',{metalness:.05,roughness:.8,color:'#64748b'})),
    React.createElement('mesh',{castShadow:true,position:[0,0,0]},
      React.createElement('cylinderGeometry',{args:[.6,.6,.1,36]}),
      React.createElement('meshStandardMaterial',{metalness:.05,roughness:.9,color:'#94a3b8'})))}
  function useBlobURL(f){const[u,setU]=useState(null);useEffect(()=>{if(!f){setU(null);return}const u=URL.createObjectURL(f);setU(u);return()=>URL.revokeObjectURL(u)},[f]);return u}
  function loadTex(file,{colorSpace=THREE.NoColorSpace,flipY=false}={}){return new Promise((ok,bad)=>{if(!file)return ok(null);const u=URL.createObjectURL(file);new THREE.TextureLoader().load(u,t=>{t.flipY=flipY;t.colorSpace=colorSpace;t.anisotropy=4;ok(t);URL.revokeObjectURL(u)},void 0,e=>{bad(e);URL.revokeObjectURL(u)})})}
  function applyMaps(root,m){root.traverse(o=>{if(!o.isMesh)return;const a=o.material;if(!a||Array.isArray(a))return;
    if(m.baseColor){if(!a.map)a.map=m.baseColor;a.map&&(a.map.needsUpdate=true)}
    if(m.normal){if(!a.normalMap)a.normalMap=m.normal;a.normalMap&&(a.normalMap.needsUpdate=true)}
    if(m.orm){if(!a.roughnessMap)a.roughnessMap=m.orm;if(!a.metalnessMap)a.metalnessMap=m.orm;if(!a.aoMap)a.aoMap=m.orm;
      a.roughnessMap&&(a.roughnessMap.needsUpdate=true);a.metalnessMap&&(a.metalnessMap.needsUpdate=true);a.aoMap&&(a.aoMap.needsUpdate=true)}
    a.needsUpdate=true})}
  function useFocus(obj){const[s,setS]=useState({center:new THREE.Vector3(0,.45,0),radius:1,height:1.2});useEffect(()=>{if(!obj)return;const b=new THREE.Box3().setFromObject(obj),sz=new THREE.Vector3();b.getSize(sz);const c=new THREE.Vector3();b.getCenter(c);const r=Math.max(sz.x,sz.y,sz.z)*.5||1;setS({center:c,radius:r,height:sz.y})},[obj]);return s}
  function GLB({glbFile,maps,onLoaded}){const url=useBlobURL(glbFile);const {scene}=useGLTF(url);useEffect(()=>{scene&&onLoaded&&onLoaded(scene)},[scene,onLoaded]);
    useEffect(()=>{if(!scene)return;if(maps&&(maps.baseColor||maps.normal||maps.orm))applyMaps(scene,maps)},[scene,maps]);
    const g=useRef();useEffect(()=>{if(!scene||!g.current)return;const b=new THREE.Box3().setFromObject(scene),c=new THREE.Vector3();b.getCenter(c);scene.position.sub(c)},[scene]);
    return React.createElement('group',{ref:g},scene&&React.createElement('primitive',{object:scene}))}
  function Omni({t,style,dist,elevDeg,speed,fov,focus,content}){const cam=useRef();useFrame(()=>{const p=cp(t,{style,dist,elevDeg,speed,focus});if(cam.current){cam.current.fov=fov;cam.current.position.set(...p.position);cam.current.lookAt(...p.target);cam.current.updateProjectionMatrix()}});useHelper(cam,THREE.CameraHelper,'#60a5fa');
    return React.createElement(Canvas,{shadows:true,dpr:[1,2],camera:{position:[6,4,6],fov:55}},
      React.createElement('color',{attach:'background',args:['#020617']}),React.createElement('fog',{attach:'fog',args:['#020617',20,60]}),
      React.createElement('ambientLight',{intensity:.55}),
      React.createElement('directionalLight',{castShadow:true,position:[6,8,4],intensity:1.1,'shadow-mapSize':[1024,1024]},
        React.createElement('orthographicCamera',{attach:'shadow-camera',args:[-10,10,10,-10,.5,50]})),
      React.createElement(G,null),React.createElement(Suspense,{fallback:React.createElement(D,null)},content),
      React.createElement(PerspectiveCamera,{ref:cam,makeDefault:false,near:.05,far:200}),
      React.createElement(OrbitControls,{makeDefault:true,enablePan:true,enableZoom:true,enableRotate:true}))}
  function CamView({t,style,dist,elevDeg,speed,fov,focus,content}){const {camera}=useThree();useFrame(()=>{const p=cp(t,{style,dist,elevDeg,speed,focus});camera.fov=fov;camera.position.set(...p.position);camera.lookAt(...p.target);camera.updateProjectionMatrix()});
    return React.createElement(React.Fragment,null,
      React.createElement('color',{attach:'background',args:['#0b1020']}),React.createElement('ambientLight',{intensity:.45}),
      React.createElement('directionalLight',{position:[6,8,4],intensity:1.0}),React.createElement(G,null),
      React.createElement(Suspense,{fallback:React.createElement(D,null)},content))}
  function Controls({style,setStyle,distance,setDistance,angle,setAngle,fov,setFov,speed,setSpeed,playing,setPlaying}){return React.createElement('div',{className:'flex flex-wrap items-center gap-3'},
    React.createElement('div',{className:'flex items-center gap-2'},React.createElement('span',{className:'text-xs uppercase tracking-wider text-slate-400'},'運鏡'),
      React.createElement('select',{className:'bg-slate-800 text-slate-100 rounded-xl px-3 py-2 text-sm border border-slate-700',value:style,onChange:e=>setStyle(e.target.value)},
        React.createElement('option',{value:'STATIC'},'靜態'),React.createElement('option',{value:'ORBIT'},'環繞（Arc/Orbit）'),
        React.createElement('option',{value:'DOLLY'},'推軌（Dolly）'),React.createElement('option',{value:'TRUCK'},'橫移（Truck）'),
        React.createElement('option',{value:'CRANE'},'搖臂（Crane）'))),
    React.createElement('div',{className:'flex items-center gap-2'},React.createElement('span',{className:'text-xs uppercase tracking-wider text-slate-400'},'距離'),
      React.createElement('div',{className:'flex items-center gap-1 bg-slate-800 rounded-xl p-1 border border-slate-700'},
        ['CLOSE','MEDIUM','WIDE'].map(k=>React.createElement('button',{key:k,onClick:()=>setDistance(k),
          className:`px-3 py-1.5 text-xs rounded-lg transition ${distance===k?'bg-indigo-600 text-white':'text-slate-200 hover:bg-slate-700'}`},
          k==='CLOSE'?'CLOSE-SHOT':k==='WIDE'?'WIDER-SHOT':'MEDIUM')))),
    React.createElement('div',{className:'flex items-center gap-2'},React.createElement('span',{className:'text-xs uppercase tracking-wider text-slate-400'},'角度'),
      React.createElement('select',{className:'bg-slate-800 text-slate-100 rounded-xl px-3 py-2 text-sm border border-slate-700',value:angle,onChange:e=>setAngle(e.target.value)},
        React.createElement('option',{value:'BIRD'},'鳥瞰'),React.createElement('option',{value:'HIGH'},'高角度'),
        React.createElement('option',{value:'LEVEL'},'水平'),React.createElement('option',{value:'LOW'},'低角度'))),
    React.createElement('div',{className:'flex items-center gap-2'},React.createElement('span',{className:'text-xs uppercase tracking-wider text-slate-400'},'FOV'),
      React.createElement('input',{type:'range',min:20,max:85,value:fov,onChange:e=>setFov(parseFloat(e.target.value))}),
      React.createElement('span',{className:'text-slate-300 text-sm w-10 text-right'},Math.round(fov)+'°')),
    React.createElement('div',{className:'flex items-center gap-2'},React.createElement('span',{className:'text-xs uppercase tracking-wider text-slate-400'},'速度'),
      React.createElement('input',{type:'range',min:.2,max:2.5,step:.1,value:speed,onChange:e=>setSpeed(parseFloat(e.target.value))}),
      React.createElement('span',{className:'text-slate-300 text-sm w-10 text-right'},speed.toFixed(1)+'x')),
    React.createElement('div',{className:'ml-auto flex items-center gap-2'},
      React.createElement('button',{onClick:()=>setPlaying(p=>!p),className:'px-3 py-2 text-sm rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white shadow'},playing?'暫停':'播放')))}
  function App(){const[style,setStyle]=useState('ORBIT'),[distance,setDistance]=useState('MEDIUM'),[angle,setAngle]=useState('LEVEL'),[fov,setFov]=useState(50),[speed,setSpeed]=useState(.8),[playing,setPlaying]=useState(true),[glbFile,setGlbFile]=useState(null),[maps,setMaps]=useState({baseColor:null,normal:null,orm:null}),[t,setT]=useState(0);
    useEffect(()=>{let r,last=performance.now();const loop=now=>{const dt=(now-last)/1e3;last=now;if(playing)setT(v=>v+dt);r=requestAnimationFrame(loop)};r=requestAnimationFrame(loop);return()=>cancelAnimationFrame(r)},[playing])
    const[lastScene,setLastScene]=useState(null),focus=useFocus(lastScene),dist=Math.max(.5,(distance==='CLOSE'?1.4:distance==='WIDE'?4.5:2.5)*Math.max(1,focus.radius*2)),elevDeg=({BIRD:60,HIGH:30,LEVEL:0,LOW:-20})[angle];
    const content=glbFile?React.createElement(GLB,{glbFile,maps,onLoaded:setLastScene}):React.createElement(D)
    return React.createElement('div',{className:'min-h-screen w-full bg-slate-950 text-slate-100 p-5'},
      React.createElement('div',{className:'max-w-7xl mx-auto space-y-4'},
        React.createElement('div',{className:'flex items-end justify-between gap-4'},
          React.createElement('div',null,React.createElement('h1',{className:'text-2xl font-semibold tracking-tight'},'3D 運鏡模擬器'),
            React.createElement('p',{className:'text-slate-400 text-sm'},'上傳 GLB + 貼圖，並同時預覽 3D 全知視角與 2D 取景。'))),
        React.createElement('div',{className:'rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-sm space-y-4'},
          React.createElement(Controls,{style,setStyle,distance,setDistance,angle,setAngle,fov,setFov,speed,setSpeed,playing,setPlaying}),
          React.createElement('div',{className:'space-y-3'},
            React.createElement('div',{className:'text-xs text-slate-400'},'上傳 GLB 與貼圖（可選）：BaseColor、Normal、ORM（R=AO, G=Roughness, B=Metallic）'),
            React.createElement('div',{className:'grid grid-cols-1 md:grid-cols-2 gap-3'},
              React.createElement('label',{className:'flex flex-col gap-1 text-sm'},'GLB 檔',
                React.createElement('input',{className:'bg-slate-900 border border-slate-700 rounded p-2',type:'file',accept:'.glb,.gltf',onChange:e=>setGlbFile(e.target.files?.[0]||null)})),
              React.createElement('label',{className:'flex flex-col gap-1 text-sm'},'BaseColor（sRGB）',
                React.createElement('input',{className:'bg-slate-900 border border-slate-700 rounded p-2',type:'file',accept:'image/*',onChange:async e=>{const f=e.target.files?.[0];if(!f)return setMaps(m=>({...m,baseColor:null}));const tex=await loadTex(f,{colorSpace:THREE.SRGBColorSpace});setMaps(m=>({...m,baseColor:tex}))}})),
              React.createElement('label',{className:'flex flex-col gap-1 text-sm'},'Normal',
                React.createElement('input',{className:'bg-slate-900 border border-slate-700 rounded p-2',type:'file',accept:'image/*',onChange:async e=>{const f=e.target.files?.[0];if(!f)return setMaps(m=>({...m,normal:null}));const tex=await loadTex(f,{});setMaps(m=>({...m,normal:tex}))}})),
              React.createElement('label',{className:'flex flex-col gap-1 text-sm'},'ORM（AO/Rough/Metal）',
                React.createElement('input',{className:'bg-slate-900 border border-slate-700 rounded p-2',type:'file',accept:'image/*',onChange:async e=>{const f=e.target.files?.[0];if(!f)return setMaps(m=>({...m,orm:null}));const tex=await loadTex(f,{});setMaps(m=>({...m,orm:tex}))}}))),
            React.createElement('div',{className:'text-[10px] text-slate-500'},'註：GLB 若已內嵌貼圖，可不另外上傳。貼圖/GLB 僅在瀏覽器端讀取，不會上傳。'))),
        React.createElement('div',{className:'grid grid-cols-1 lg:grid-cols-2 gap-4'},
          React.createElement('div',{className:'relative rounded-2xl border border-slate-800 bg-gradient-to-b from-slate-900 to-slate-950 shadow overflow-hidden'},
            React.createElement('div',{className:'absolute z-10 left-3 top-3 text-xs bg-black/40 px-2 py-1 rounded'},'3D 全知視角'),
            React.createElement(Omni,{t,style,dist:dist,elevDeg,speed,fov,focus,content})),
          React.createElement('div',{className:'relative rounded-2xl border border-slate-800 bg-slate-900 shadow overflow-hidden'},
            React.createElement('div',{className:'absolute z-10 left-3 top-3 text-xs bg-black/40 px-2 py-1 rounded'},'2D 鏡頭視角'),
            React.createElement('div',{className:'aspect-[16/9] w-full'},
              React.createElement(Canvas,{shadows:true,dpr:[1,2],camera:{position:[3,2,3],fov}},
                React.createElement(CamView,{t,style,dist:dist,elevDeg,speed,fov,focus,content})),
              React.createElement('div',{className:'pointer-events-none absolute inset-0'},
                React.createElement('div',{className:'absolute inset-0 grid grid-cols-3 grid-rows-3'},
                  [0,1,2,3].map(i=>React.createElement('div',{key:i,className:'border-slate-600/30',style:{borderRightWidth:i%3===2?0:1,borderBottomWidth:i<6?1:0}}))),
                React.createElement('div',{className:'absolute inset-3 border border-white/20 rounded'})))))) }
  createRoot(document.getElementById('root')).render(React.createElement(App))
</script></body></html>
